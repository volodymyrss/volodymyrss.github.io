
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ISGRI Low Energy Charge Loss &#8212; IBIS/ISGRI modeling troubles</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Intra-revolution polarization" href="rapid-polarization.html" />
    <link rel="prev" title="Introduction to INTEGRAL IBIS/ISGRI modelling troubles" href="landing-page.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">IBIS/ISGRI modeling troubles</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="landing-page.html">
   Introduction to INTEGRAL IBIS/ISGRI modelling troubles
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   ISGRI Low Energy Charge Loss
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rapid-polarization.html">
   Intra-revolution polarization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="efficiency-imaging-nomex.html">
   ISGRI Low Energy efficiency
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="effi-rsp-lut2.html">
   Calibration invariance of LUT2, rsp, efficiency
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="resolution.html">
   Resolution
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/le-gain-offset.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/le-gain-offset.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   ISGRI Low Energy Charge Loss
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#detector-polarization">
   Detector polarization
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mismatch-between-no-polarization-model-and-in-flight-source-observations">
   Mismatch between no-polarization model and in-flight source observations
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#effects-of-offset">
   Effects of offset
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">gaussian_filter1d</span> <span class="k">as</span> <span class="n">g1d</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
</pre></div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="isgri-low-energy-charge-loss">
<h1>ISGRI Low Energy Charge Loss<a class="headerlink" href="#isgri-low-energy-charge-loss" title="Permalink to this headline">¶</a></h1>
<p>OSA11 charge loss model is fitted to lines at ~60 keV and 511 keV.
Trivial extrapolation of the evolution to 20 keV would lead to clear mismatch with ground calibration lines (applicable early mission) and cross-calibration obsevations (applicable late mission).</p>
<p>At ~22 keV there is a Cd line complex (<a class="reference external" href="https://xdb.lbl.gov/Section1/Table_1-2.pdf">see</a>), but it’s hard to use it due to several effects (in the order from more important to less important):</p>
<ul class="simple">
<li><p>low energy cut-off by pixel threshold. This effect appears as shift to high energy. The LE threshold can be only reasonably determined with astrophysical source observations.</p></li>
<li><p>energy resolution. Since since the broadened line is cutoff at low energy, it unequally broadens to high energy. Resolution at LE can only be rather approximately determined with astrophysical source observations.</p></li>
<li><p>underlying background is very variable at low energy, and sensitive to CR-induced activation. Also astrophysical sources brighter than 300 mCrab are comparable to background level, and bias energy estimation depending on the source spectrum, usually to high energy. It is possible to exclude particularly anomalous background conditions, but long-term trends are hard to disentangle from other effects. See <a class="reference external" href="https://volodymyrss.github.io/imgb/history.html">there</a></p></li>
</ul>
<p>For realistic magnitude of these effects, the shifts may lead to apparent line centroid from 20 to 30 keV, for actual line at 22 keV. See example below.</p>
<p>Below, shown separately background and source rates</p>
<table><tr>
<td><img src="https://volodymyrss.github.io/imgb/detelc_decomposed.png.1406121161.88b8ca491b" width="500px"></td>
<td><img src="https://volodymyrss.github.io/imgb/history.png.1406120164.1771a51d05" width="500px"></td>
</tr></table>
<!-- <img src="images/isgri-pixel.svg"> --><div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">SVG</span>
<span class="n">SVG</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;images/isgri-pixel.svg&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/le-gain-offset_3_0.svg" src="_images/le-gain-offset_3_0.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">importlib</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;EDDOSA_TOOLS_DIR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/eddosa_tools/&#39;</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;dda-ddosa&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;dda-eddosa&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;eddosa_tools/fit1d&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;lut2model/python&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">lut2model</span>
<span class="kn">import</span> <span class="nn">bipar_model</span>
<span class="kn">import</span> <span class="nn">eddosa</span>

<span class="n">lut2model</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">importlib</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">bipar_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;module &#39;bipar_model&#39; from &#39;/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py&#39;&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">importlib</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">bipar_model</span><span class="p">)</span>
<span class="n">det_base</span> <span class="o">=</span> <span class="n">bipar_model</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">from_lut2_fits</span><span class="p">(</span><span class="s1">&#39;/mnt/sshfs/cdcihn/unsaved/astro/savchenk/data/reduced/ddcache/byrev/0239/FinalizeLUT2.xvbase5.2/4711debf/lut2_1d_final.fits.gz&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">det_base</span><span class="p">)</span>

<span class="n">ilut2_base</span><span class="p">,</span> <span class="n">i1d_base</span> <span class="o">=</span> <span class="n">det_base</span><span class="o">.</span><span class="n">generate_approximate_reconstruction</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>setting mu_e
setting mu_t
setting tau_e
setting tau_t
setting offset
setting gain
setting v
(869.5551914492459, 57.46021435346341, 1.13761700113863e-06, 5.96321625870866e-06, 120.0, -8.409137047104311)
(detector: V=120 mu_e=869.56 mu_t=57.46 tau_e=1.1376e-06 tau_t=5.9632e-06 offset=-8.4091 rt_offset=5
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:406: RuntimeWarning: invalid value encountered in double_scalars
  #print &quot;Py&quot;,q_bip,rt_bip,sig_cc
/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:272: RuntimeWarning: invalid value encountered in true_divide
  pha_vs_rt = np.nansum(bip * pha_2d, 1) / np.nansum(bip, 1)
/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:406: RuntimeWarning: invalid value encountered in double_scalars
  #print &quot;Py&quot;,q_bip,rt_bip,sig_cc
/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:272: RuntimeWarning: invalid value encountered in true_divide
  pha_vs_rt = np.nansum(bip * pha_2d, 1) / np.nansum(bip, 1)
/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:406: RuntimeWarning: invalid value encountered in double_scalars
  #print &quot;Py&quot;,q_bip,rt_bip,sig_cc
/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:272: RuntimeWarning: invalid value encountered in true_divide
  pha_vs_rt = np.nansum(bip * pha_2d, 1) / np.nansum(bip, 1)
/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:406: RuntimeWarning: invalid value encountered in double_scalars
  #print &quot;Py&quot;,q_bip,rt_bip,sig_cc
/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:272: RuntimeWarning: invalid value encountered in true_divide
  pha_vs_rt = np.nansum(bip * pha_2d, 1) / np.nansum(bip, 1)
/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:406: RuntimeWarning: invalid value encountered in double_scalars
  #print &quot;Py&quot;,q_bip,rt_bip,sig_cc
/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:272: RuntimeWarning: invalid value encountered in true_divide
  pha_vs_rt = np.nansum(bip * pha_2d, 1) / np.nansum(bip, 1)
/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:272: RuntimeWarning: invalid value encountered in true_divide
  pha_vs_rt = np.nansum(bip * pha_2d, 1) / np.nansum(bip, 1)
/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:272: RuntimeWarning: invalid value encountered in true_divide
  pha_vs_rt = np.nansum(bip * pha_2d, 1) / np.nansum(bip, 1)
/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:272: RuntimeWarning: invalid value encountered in true_divide
  pha_vs_rt = np.nansum(bip * pha_2d, 1) / np.nansum(bip, 1)
/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:272: RuntimeWarning: invalid value encountered in true_divide
  pha_vs_rt = np.nansum(bip * pha_2d, 1) / np.nansum(bip, 1)
/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:272: RuntimeWarning: invalid value encountered in true_divide
  pha_vs_rt = np.nansum(bip * pha_2d, 1) / np.nansum(bip, 1)
/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:272: RuntimeWarning: invalid value encountered in true_divide
  pha_vs_rt = np.nansum(bip * pha_2d, 1) / np.nansum(bip, 1)
/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:272: RuntimeWarning: invalid value encountered in true_divide
  pha_vs_rt = np.nansum(bip * pha_2d, 1) / np.nansum(bip, 1)
/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:272: RuntimeWarning: invalid value encountered in true_divide
  pha_vs_rt = np.nansum(bip * pha_2d, 1) / np.nansum(bip, 1)
/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:272: RuntimeWarning: invalid value encountered in true_divide
  pha_vs_rt = np.nansum(bip * pha_2d, 1) / np.nansum(bip, 1)
/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:272: RuntimeWarning: invalid value encountered in true_divide
  pha_vs_rt = np.nansum(bip * pha_2d, 1) / np.nansum(bip, 1)
/home/savchenk/.pyenv/versions/3.9.6/lib/python3.9/site-packages/scipy/interpolate/_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the number of B-spline
coefficients already exceeds the number of data points m.
Probable causes: either s or m too small. (fp&gt;s)
	kx,ky=1,1 nx,ny=36,32 m=999 fp=0.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
</pre></div>
</div>
<img alt="_images/le-gain-offset_5_2.png" src="_images/le-gain-offset_5_2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">en</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>


<span class="n">raw_line</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">en</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">leeffi</span><span class="p">(</span><span class="n">en</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">sharpness</span><span class="o">=</span><span class="mi">14</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">en</span><span class="o">/</span><span class="n">position</span><span class="p">)</span><span class="o">**</span><span class="n">sharpness</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">en</span><span class="o">/</span><span class="n">position</span><span class="p">)</span><span class="o">**</span><span class="n">sharpness</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">lecutoff</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">g1d</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span><span class="o">*</span><span class="n">leeffi</span><span class="p">(</span><span class="n">en</span><span class="p">,</span> <span class="n">lecutoff</span><span class="p">)</span>


<span class="k">for</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">lecutoff</span><span class="p">,</span> <span class="n">extrabkg</span> <span class="ow">in</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>    
    <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mf">0.05</span><span class="o">*</span><span class="p">(</span><span class="n">en</span><span class="o">/</span><span class="mi">30</span><span class="p">)</span><span class="o">**-</span><span class="mi">2</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mf">0.05</span><span class="o">*</span><span class="p">(</span><span class="n">en</span><span class="o">/</span><span class="mi">30</span><span class="p">)</span><span class="o">**-</span><span class="mi">3</span><span class="p">),</span>
<span class="p">]:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">en</span> <span class="o">&lt;</span> <span class="mi">50</span>
    <span class="n">obs_nole</span> <span class="o">=</span> <span class="n">observe</span><span class="p">(</span><span class="n">raw_line</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="n">observe</span><span class="p">(</span><span class="n">raw_line</span> <span class="o">+</span> <span class="n">extrabkg</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">lecutoff</span><span class="p">)</span>

    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">en</span><span class="o">*</span><span class="n">obs</span><span class="p">)[</span><span class="n">m</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">((</span><span class="n">obs_nole</span><span class="o">*</span><span class="n">en</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="n">m</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">obs_nole</span><span class="p">[</span><span class="n">m</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">((</span><span class="n">obs_nole</span><span class="o">*</span><span class="n">en</span><span class="p">)[</span><span class="n">m</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">obs_nole</span><span class="p">[</span><span class="n">m</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">en</span><span class="p">,</span>
        <span class="n">obs</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;sigma: </span><span class="si">{</span><span class="n">sigma</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">width</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> keV) lecutoff: </span><span class="si">{</span><span class="n">lecutoff</span><span class="si">}</span><span class="s2"> keV: resulting mean </span><span class="si">{</span><span class="n">mean</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> keV&quot;</span>
    <span class="p">)</span>



<span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mf">1e-5</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1e-05, 10)
</pre></div>
</div>
<img alt="_images/le-gain-offset_6_1.png" src="_images/le-gain-offset_6_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#lut2model.render_bipar_m0()</span>

<span class="n">det</span> <span class="o">=</span> <span class="n">det_base</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">pha_2d</span><span class="p">,</span> <span class="n">rt_2d</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">mesh</span><span class="p">()</span>


<span class="n">bip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pha_2d</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
<span class="k">for</span> <span class="n">en</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">22</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">511</span><span class="p">]:</span>
    <span class="n">_bip</span> <span class="o">=</span> <span class="n">bipar_model</span><span class="o">.</span><span class="n">make_bipar_monoenergetic</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="n">en</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    
    <span class="n">bip</span> <span class="o">+=</span> <span class="n">_bip</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="n">_bip</span><span class="p">[</span><span class="n">_bip</span><span class="o">&gt;</span><span class="n">_bip</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="mf">0.5</span><span class="p">)</span>

<span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">pha_2d</span><span class="p">,</span> <span class="n">rt_2d</span><span class="p">,</span> <span class="n">bip</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">bip</span><span class="o">**</span><span class="mf">0.5</span><span class="p">))</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">pha_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span>
    <span class="n">bip</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">30</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">15</span><span class="p">,</span> <span class="mi">2000</span><span class="p">])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">16</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;different lines for baseline model&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;PHA (ISGRI Pulse Height channel)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;RT (ISGRI Rise Time channel)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;RT (ISGRI Rise Time channel)&#39;)
</pre></div>
</div>
<img alt="_images/le-gain-offset_7_1.png" src="_images/le-gain-offset_7_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">spec</span> <span class="o">=</span> <span class="n">bip</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">30</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">en_base</span> <span class="o">=</span> <span class="n">i1d_base</span><span class="p">(</span><span class="n">pha_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">en_base</span><span class="p">,</span>
    <span class="n">spec</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">en</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">22</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">511</span><span class="p">,</span> <span class="mi">150</span><span class="p">]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">en</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
<img alt="_images/le-gain-offset_8_1.png" src="_images/le-gain-offset_8_1.png" />
</div>
</div>
<p>#TODO: total event number lost to high RT threshold
#TODO: discontinuities from abs edges</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pha_2d</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="n">lrt_lines</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

<span class="n">N</span><span class="o">=</span><span class="mi">20</span>

<span class="n">energies</span> <span class="o">=</span> <span class="p">[</span><span class="mi">22</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">511</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i_loss</span><span class="p">,</span> <span class="n">tau_loss_factor</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">)):</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">det_base</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">det</span><span class="o">.</span><span class="n">tau_e</span> <span class="o">=</span> <span class="n">det_base</span><span class="o">.</span><span class="n">tau_e</span> <span class="o">*</span> <span class="n">tau_loss_factor</span>

    <span class="n">this_loss_bip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">bip</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">en</span> <span class="ow">in</span> <span class="n">energies</span><span class="p">:</span>
        <span class="n">_bip</span> <span class="o">=</span> <span class="n">bipar_model</span><span class="o">.</span><span class="n">make_bipar_monoenergetic</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="n">en</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">rt1</span><span class="p">,</span> <span class="n">rt2</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">15</span><span class="p">,</span><span class="mi">30</span><span class="p">),</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">70</span><span class="p">)]:</span>
            <span class="n">ltr_bip</span> <span class="o">=</span> <span class="n">_bip</span><span class="p">[</span><span class="n">rt1</span><span class="p">:</span><span class="n">rt2</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">lrt_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">rt1</span><span class="o">=</span><span class="n">rt1</span><span class="p">,</span>
                    <span class="n">rt2</span><span class="o">=</span><span class="n">rt2</span><span class="p">,</span>
                    <span class="n">energy</span><span class="o">=</span><span class="n">en</span><span class="p">,</span>
                    <span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span>
                    <span class="n">mean_pha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pha_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">*</span><span class="n">ltr_bip</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ltr_bip</span><span class="p">),</span>
                    <span class="n">_bip</span><span class="o">=</span><span class="n">_bip</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="p">)</span>
        
        <span class="n">this_loss_bip</span> <span class="o">+=</span> <span class="n">_bip</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="n">_bip</span><span class="p">[</span><span class="n">_bip</span><span class="o">&gt;</span><span class="n">_bip</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="mf">0.5</span><span class="p">)</span>        
    
    <span class="n">bip</span> <span class="o">+=</span> <span class="n">this_loss_bip</span>

    <span class="k">if</span> <span class="n">i_loss</span> <span class="o">%</span> <span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">this_loss_bip</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">30</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-4</span>

        <span class="n">c</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">pha_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">m</span><span class="p">],</span>
            <span class="n">spec</span><span class="p">[</span><span class="n">m</span><span class="p">],</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">en_base</span><span class="p">[</span><span class="n">m</span><span class="p">],</span>
            <span class="n">spec</span><span class="p">[</span><span class="n">m</span><span class="p">],</span>
            <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="n">c</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">i_loss</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">en</span> <span class="ow">in</span> <span class="n">energies</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">en</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        
        

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tau_loss and reconstruction with </span><span class="si">{</span><span class="n">det_base</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">pha_2d</span><span class="p">,</span> <span class="n">rt_2d</span><span class="p">,</span> <span class="n">bip</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">bip</span><span class="o">**</span><span class="mf">0.5</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2000</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;PHA (ISGRI Pulse Height channel)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;RT (ISGRI Rise Time channel)&#39;</span><span class="p">)</span>

<span class="c1"># for vl in vlines:</span>
<span class="c1">#     plt.axvline(vl)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;RT (ISGRI Rise Time channel)&#39;)
</pre></div>
</div>
<img alt="_images/le-gain-offset_10_1.png" src="_images/le-gain-offset_10_1.png" />
<img alt="_images/le-gain-offset_10_2.png" src="_images/le-gain-offset_10_2.png" />
</div>
</div>
<p>Charge loss model, in principle, results in a prescription to how low-energy part evolves. This prescription is somewaht different from simple linear change of offset and gain. But not as different as what is observed at low energy.</p>
<p>Prescriptions for evolution at different energies are are shown below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cmap_sequence</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">winter</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">autumn</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">spring</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">summer</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="k">for</span> <span class="n">en</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lrt_lines</span><span class="p">]):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ls_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;--&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">rt1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">50</span><span class="p">]:</span>
        <span class="n">mean_phas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;mean_pha&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lrt_lines</span> <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">en</span> <span class="ow">and</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;rt1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">rt1</span><span class="p">])</span>
        <span class="n">normal_phas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;mean_pha&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lrt_lines</span> <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">59</span> <span class="ow">and</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;rt1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">rt1</span><span class="p">])</span>
        <span class="n">ls</span><span class="o">=</span><span class="n">ls_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">c</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;det&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tau_e</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lrt_lines</span> <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">en</span>  <span class="ow">and</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;rt1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">rt1</span><span class="p">],</span>
            <span class="n">mean_phas</span><span class="o">/</span><span class="n">mean_phas</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="n">normal_phas</span><span class="o">*</span><span class="n">normal_phas</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">en</span><span class="si">}</span><span class="s2"> keV rt </span><span class="si">{</span><span class="n">rt1</span><span class="si">}</span><span class="s2"> relative to 59 keV&quot;</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
            <span class="n">ls</span><span class="o">=</span><span class="n">ls</span><span class="p">,</span>
            <span class="n">lw</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">()</span>

        <span class="n">c</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;det&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tau_e</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lrt_lines</span> <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">en</span>  <span class="ow">and</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;rt1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">rt1</span><span class="p">],</span>
            <span class="n">mean_phas</span><span class="o">/</span><span class="n">mean_phas</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">en</span><span class="si">}</span><span class="s2"> keV rt </span><span class="si">{</span><span class="n">rt1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
            <span class="n">ls</span><span class="o">=</span><span class="n">ls</span><span class="p">,</span>
            <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span>            
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">()</span>


<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="c1">#plt.semilogx()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;loss of PHA as $</span><span class="se">\t</span><span class="s2">au_e$ degrades with mission lifetime: ???&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;- log$_</span><span class="si">{10}</span><span class="s2">~\tau_e$ (grows with mission lifetime)&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;fraction of PH lost&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;fraction of PH lost&#39;)
</pre></div>
</div>
<img alt="_images/le-gain-offset_13_1.png" src="_images/le-gain-offset_13_1.png" />
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="detector-polarization">
<h1>Detector polarization<a class="headerlink" href="#detector-polarization" title="Permalink to this headline">¶</a></h1>
<p>As discussed above, assuming no polarization, or uniform polarization does not reproduce low-energy response compatible with observations.</p>
<p>Since detector is always polarized, it’s hard to distinguish effect of degradation of charge carrior properties due to irradiation from
polarization.</p>
<p>Especially if the polarization is inhomogenous. And since polarization effect itself is known to depend on irradiation dose itself, just as charge carried properties do.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pha_2d</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="n">lrt_lines</span> <span class="o">=</span> <span class="p">[]</span>


<span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#for tau_loss_factor in np.logspace(-1., 0, 3):</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">20</span>
<span class="k">for</span> <span class="n">i_loss</span><span class="p">,</span> <span class="n">V_loss_factor</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">)):</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">bipar_model</span><span class="o">.</span><span class="n">detector</span><span class="p">()</span>
    <span class="c1">#det.tau_e = det_base.tau_e * tau_loss_factor</span>
    <span class="n">det</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">det_base</span><span class="o">.</span><span class="n">V</span> <span class="o">*</span> <span class="n">V_loss_factor</span>

    <span class="n">c</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;V = </span><span class="si">{</span><span class="n">det</span><span class="o">.</span><span class="n">V</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">for</span> <span class="n">en</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">511</span><span class="p">]:</span>
        <span class="n">_bip</span> <span class="o">=</span> <span class="n">bipar_model</span><span class="o">.</span><span class="n">make_bipar_monoenergetic</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="n">en</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">rt1</span><span class="p">,</span> <span class="n">rt2</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">15</span><span class="p">,</span><span class="mi">30</span><span class="p">),</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">70</span><span class="p">)]:</span>
            <span class="n">ltr_bip</span> <span class="o">=</span> <span class="n">_bip</span><span class="p">[</span><span class="n">rt1</span><span class="p">:</span><span class="n">rt2</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">lrt_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">rt1</span><span class="o">=</span><span class="n">rt1</span><span class="p">,</span>
                    <span class="n">rt2</span><span class="o">=</span><span class="n">rt2</span><span class="p">,</span>
                    <span class="n">energy</span><span class="o">=</span><span class="n">en</span><span class="p">,</span>
                    <span class="n">tau_e</span><span class="o">=</span><span class="n">det</span><span class="o">.</span><span class="n">tau_e</span><span class="p">,</span>
                    <span class="n">V</span><span class="o">=</span><span class="n">det</span><span class="o">.</span><span class="n">V</span><span class="p">,</span>
                    <span class="n">mean_pha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pha_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">*</span><span class="n">ltr_bip</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ltr_bip</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="p">)</span>
        
        <span class="n">bip</span> <span class="o">+=</span> <span class="n">_bip</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="n">_bip</span><span class="p">[</span><span class="n">_bip</span><span class="o">&gt;</span><span class="n">_bip</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="mf">0.5</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">i_loss</span> <span class="o">%</span> <span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">pha_2d</span><span class="p">,</span> <span class="n">rt_2d</span><span class="p">,</span> <span class="n">_bip</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">_bip</span><span class="o">**</span><span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i_loss</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">))]</span>
            <span class="p">)</span>
         
            <span class="n">c</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">pha_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span>
                <span class="n">_bip</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">30</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">_bip</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">30</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span>
                <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">label</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">()</span>
            <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>



<span class="c1">#plt.figure(figsize=(15, 8))</span>
<span class="c1">#plt.contourf(pha_2d, rt_2d, bip**0.5, levels=np.logspace(-1, 0)*np.nanmax(bip**0.5))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;field (V, polarization) effect on charge collection&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">30</span><span class="p">,</span> <span class="mi">2000</span><span class="p">])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">16</span><span class="p">,</span> <span class="mi">116</span><span class="p">])</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;PHA (ISGRI Pulse Height channel)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;RT (ISGRI Rise Time channel)&#39;</span><span class="p">)</span>

<span class="c1"># for vl in lrt_lines:</span>
<span class="c1">#     plt.axvline(vl[&#39;mean_pha&#39;])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;RT (ISGRI Rise Time channel)&#39;)
</pre></div>
</div>
<img alt="_images/le-gain-offset_15_1.png" src="_images/le-gain-offset_15_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="k">for</span> <span class="n">en</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lrt_lines</span><span class="p">]):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ls_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;--&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">rt1</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">50</span><span class="p">]:</span>
        <span class="n">normal_phas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;mean_pha&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lrt_lines</span> <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">59</span> <span class="ow">and</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;rt1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">rt1</span><span class="p">])</span>
        <span class="n">normal_phas</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">normal_phas</span><span class="p">)</span>

        <span class="n">mean_phas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;mean_pha&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lrt_lines</span> <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">en</span> <span class="ow">and</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;rt1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">rt1</span><span class="p">])</span>
        <span class="n">c</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lrt_lines</span> <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">en</span>  <span class="ow">and</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;rt1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">rt1</span><span class="p">],</span>
            <span class="n">mean_phas</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">mean_phas</span><span class="p">)</span><span class="o">/</span><span class="n">normal_phas</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">en</span><span class="si">}</span><span class="s2"> keV rt </span><span class="si">{</span><span class="n">rt1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
            <span class="n">ls</span><span class="o">=</span><span class="n">ls_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">lw</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="c1">#plt.semilogx()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;fraction of PH lost normalized to loss at 60 keV&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

<span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(122.21425593311884, 73.50062540450435)
</pre></div>
</div>
<img alt="_images/le-gain-offset_16_1.png" src="_images/le-gain-offset_16_1.png" />
</div>
</div>
<p>As shown in the picture above, drop of the bias <code class="docutils literal notranslate"><span class="pre">V</span></code> (or, more directly, field <code class="docutils literal notranslate"><span class="pre">E</span></code>) leading to drop in the field in the detector, would cause more rapid loss of gain at low energy than at high energy. Which is the opposite of what is observed.</p>
<p>High-RT counts correspond to low-depth interactions spread with RT resolution (at low energy) or  actually high-depth interactions. The latter are less affected.</p>
<p>So, some other effect is at play, possibly inhomogenous polarization. It is not immediately clear what kind.</p>
<p>Fortunately, polarization can be also observed directly following detector switch-on. It can not be used to give direct prescription for long-term polarization change, but it can give an insight.</p>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="mismatch-between-no-polarization-model-and-in-flight-source-observations">
<h1>Mismatch between no-polarization model and in-flight source observations<a class="headerlink" href="#mismatch-between-no-polarization-model-and-in-flight-source-observations" title="Permalink to this headline">¶</a></h1>
<p>Observations with cyclotron line sources indicate excessive compression of reconstructed energy scale by up to 10% at 30 keV (see <a class="reference external" href="https://gitlab.astro.unige.ch/integral/cc-workflows/cc-global-summary/-/blob/master/verify.ipynb">CC-summary</a>)</p>
<p>Roughly speaking, the model predicts that 30 keV converts PHA=30 to 2021. But we observe that 30 keV converts to PHA=50. #TODO: think again!</p>
<p>It means that charge collection for 30 keV depositions (which, inevitably, all happen near the detector surface, just as 60 keV depositions) remain more efficient than expected, despite substantial loss of electron lifetime, as seen in charge collection for 59 and 511 keV.</p>
<p>#TODO: insert pic from offsets</p>
<p>#TODO: how is it possible that 60 keV is shifted differently than 30 keV?</p>
<ul class="simple">
<li><p>additional unaccounted shift at 511 keV by about XX</p></li>
<li><p>additional unaccounted shift at 59 keV by about XX</p></li>
</ul>
<p>When fitting with the model with variable offset by no additional free parameters (no polarization change, for example), this appears as drop in offset.
In principle, offset is expected to be constant.</p>
<p>#TODO: think!
So the effect is the opposite of what is observed.</p>
<ul class="simple">
<li><p>Polarization has the same direction as usual degradation, does not help</p></li>
<li><p>inhomogenous polarization will still affect lRT PHA for LE just as HE lines.</p></li>
</ul>
<p>Astro observations seems to suggest that constant offset would work.</p>
<p>#TODO: end-goal here is to show how to:</p>
<ul class="simple">
<li><p>enforce constant offset in efficiency, events, response</p></li>
<li><p>centralize response</p></li>
</ul>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="effects-of-offset">
<h1>Effects of offset<a class="headerlink" href="#effects-of-offset" title="Permalink to this headline">¶</a></h1>
<p>ISGRI has negative offset. This is complicating reconstruction since it is difficult to characterize behavior near</p>
<p>Since, as explained above, it is not easy to characterize EN-PHA conversion at low energy,</p>
<p>the calibration line evolution as observed indicates</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO: measure or mimick gain from HE line alone, and from LE line alone. find which one mismatches</span>


<span class="n">bip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pha_2d</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="n">lrt_lines</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">extra_ticks</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">en_rec</span> <span class="o">=</span> <span class="kc">None</span>


<span class="c1">#for tau_loss_factor in np.logspace(-1., 0, 3):</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">5</span>
<span class="k">for</span> <span class="n">i_loss</span><span class="p">,</span> <span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="n">V_loss_factor</span><span class="p">,</span> <span class="n">offset_shift</span><span class="p">,</span> <span class="n">tau_loss_factor</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;loss of tau and offset&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;loss of tau to match HE&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.655</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;loss of tau to match LE&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
            <span class="c1">#(&#39;loss of V&#39;, 0.8, 0, 1),</span>
            <span class="c1">#(&#39;loss of V and tau&#39;, 0.9, 0, 0.9),</span>
            <span class="c1">#(&#39;offset drop&#39;, 1, -4, 1),</span>
        <span class="p">]):</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">bipar_model</span><span class="o">.</span><span class="n">detector</span><span class="p">()</span>
    <span class="c1">#det.tau_e = det_base.tau_e * tau_loss_factor</span>
    <span class="n">det</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">det_base</span><span class="o">.</span><span class="n">V</span> <span class="o">*</span> <span class="n">V_loss_factor</span>
    <span class="n">det</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">det_base</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">offset_shift</span>
    <span class="n">det</span><span class="o">.</span><span class="n">tau_e</span> <span class="o">=</span> <span class="n">det_base</span><span class="o">.</span><span class="n">tau_e</span> <span class="o">*</span> <span class="n">tau_loss_factor</span>

    <span class="n">c</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">comment</span><span class="si">}</span><span class="s2">: V = </span><span class="si">{</span><span class="n">det</span><span class="o">.</span><span class="n">V</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2"> offset = </span><span class="si">{</span><span class="n">det</span><span class="o">.</span><span class="n">offset</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2"> $</span><span class="se">\\</span><span class="s2">tau_e$ = </span><span class="si">{</span><span class="n">det</span><span class="o">.</span><span class="n">tau_e</span><span class="si">:</span><span class="s2">.2g</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap_sequence</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cmap_sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">en_rec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>       
        <span class="n">det_rec</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 
        <span class="n">ilut2_rec</span><span class="p">,</span> <span class="n">i1d_rec</span> <span class="o">=</span> <span class="n">det_rec</span><span class="o">.</span><span class="n">generate_approximate_reconstruction</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">en_rec</span> <span class="o">=</span> <span class="n">i1d_rec</span><span class="p">(</span><span class="n">pha_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>

    <span class="k">for</span> <span class="n">en</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">511</span><span class="p">]:</span>
        <span class="n">_bip</span> <span class="o">=</span> <span class="n">bipar_model</span><span class="o">.</span><span class="n">make_bipar_monoenergetic</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="n">en</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">rt1</span><span class="p">,</span> <span class="n">rt2</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">15</span><span class="p">,</span><span class="mi">30</span><span class="p">),</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">70</span><span class="p">)]:</span>
            <span class="n">ltr_bip</span> <span class="o">=</span> <span class="n">_bip</span><span class="p">[</span><span class="n">rt1</span><span class="p">:</span><span class="n">rt2</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">lrt_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">rt1</span><span class="o">=</span><span class="n">rt1</span><span class="p">,</span>
                    <span class="n">rt2</span><span class="o">=</span><span class="n">rt2</span><span class="p">,</span>
                    <span class="n">energy</span><span class="o">=</span><span class="n">en</span><span class="p">,</span>
                    <span class="n">tau_e</span><span class="o">=</span><span class="n">det</span><span class="o">.</span><span class="n">tau_e</span><span class="p">,</span>
                    <span class="n">V</span><span class="o">=</span><span class="n">det</span><span class="o">.</span><span class="n">V</span><span class="p">,</span>
                    <span class="n">mean_pha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pha_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">*</span><span class="n">ltr_bip</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ltr_bip</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="p">)</span>
        
        <span class="n">bip</span> <span class="o">+=</span> <span class="n">_bip</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanquantile</span><span class="p">(</span><span class="n">_bip</span><span class="p">[</span><span class="n">_bip</span><span class="o">&gt;</span><span class="n">_bip</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="mf">0.5</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">i_loss</span> <span class="o">%</span> <span class="p">(</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">pha_2d</span><span class="p">,</span> <span class="n">rt_2d</span><span class="p">,</span> <span class="n">_bip</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">_bip</span><span class="o">**</span><span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span>
            <span class="p">)</span>
         
            <span class="n">sp</span> <span class="o">=</span> <span class="n">_bip</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">30</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">_bip</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">30</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">sp</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span><span class="o">/</span><span class="mf">1e3</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">pha_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">,:][</span><span class="n">m</span><span class="p">],</span>
                <span class="n">sp</span><span class="p">[</span><span class="n">m</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">()</span>
         
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">en_rec</span><span class="p">[</span><span class="n">m</span><span class="p">],</span>
                <span class="n">sp</span><span class="p">[</span><span class="n">m</span><span class="p">],</span>
                <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                <span class="n">c</span><span class="o">=</span><span class="n">c</span>
            <span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">rec_en</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">en_rec</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">sp</span><span class="p">[</span><span class="n">m</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">comment</span><span class="si">:</span><span class="s2">30s</span><span class="si">}</span><span class="s2"> rec </span><span class="si">{</span><span class="n">rec_en</span><span class="si">:</span><span class="s2">5.3g</span><span class="si">}</span><span class="s2"> (exp </span><span class="si">{</span><span class="n">en</span><span class="si">:</span><span class="s2">5.3g</span><span class="si">}</span><span class="s2">) : </span><span class="si">{</span><span class="p">((</span><span class="n">rec_en</span><span class="o">/</span><span class="n">en</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">5.3g</span><span class="si">}</span><span class="s2"> % with&quot;</span><span class="p">,</span> <span class="n">det_rec</span><span class="p">)</span>
         
            <span class="n">extra_ticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pha_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">,:][</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">sp</span><span class="p">[</span><span class="n">m</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
            <span class="p">)</span>




<span class="c1">#plt.figure(figsize=(15, 8))</span>
<span class="c1">#plt.contourf(pha_2d, rt_2d, bip**0.5, levels=np.logspace(-1, 0)*np.nanmax(bip**0.5))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>

<span class="c1">#ax2.set_xticks(list(ax2.get_xticks()) + extra_ticks)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">extra_ticks</span><span class="p">)</span>
<span class="c1">#ax2.set_xticklabels(list(ax2.get_xticklabels()) + [str(t) for t in extra_ticks])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="si">:</span><span class="s2">.4g</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">()],</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">pha_2d</span><span class="p">,</span> <span class="n">rt_2d</span><span class="p">,</span> <span class="n">bip</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">bip</span><span class="o">**</span><span class="mf">0.5</span><span class="p">))</span>


<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2000</span><span class="p">])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">16</span><span class="p">,</span> <span class="mi">150</span><span class="p">])</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;PHA (ISGRI Pulse Height channel)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;RT (ISGRI Rise Time channel)&#39;</span><span class="p">)</span>


<span class="c1"># TODO: apply here the D-law</span>

<span class="c1"># for vl in lrt_lines:</span>
<span class="c1">#     plt.axvline(vl[&#39;mean_pha&#39;])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:406: RuntimeWarning: invalid value encountered in double_scalars
  #print &quot;Py&quot;,q_bip,rt_bip,sig_cc
/home/savchenk/integral-ibis-isgri-le-response/lut2model/python/bipar_model.py:272: RuntimeWarning: invalid value encountered in true_divide
  pha_vs_rt = np.nansum(bip * pha_2d, 1) / np.nansum(bip, 1)
/home/savchenk/.pyenv/versions/3.9.6/lib/python3.9/site-packages/scipy/interpolate/_fitpack_impl.py:977: RuntimeWarning: No more knots can be added because the number of B-spline
coefficients already exceeds the number of data points m.
Probable causes: either s or m too small. (fp&gt;s)
	kx,ky=1,1 nx,ny=34,33 m=984 fp=0.000000 s=0.000000
  warnings.warn(RuntimeWarning(_iermess2[ierm][0] + _mess))
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>loss of tau and offset         rec  25.1 (exp    25) : 0.382 % with (detector: V=120 mu_e=870 mu_t=58 tau_e=7.9633e-07 tau_t=6e-06 offset=-13.409 rt_offset=5
loss of tau and offset         rec  58.7 (exp    59) : -0.578 % with (detector: V=120 mu_e=870 mu_t=58 tau_e=7.9633e-07 tau_t=6e-06 offset=-13.409 rt_offset=5
loss of tau and offset         rec   509 (exp   511) : -0.488 % with (detector: V=120 mu_e=870 mu_t=58 tau_e=7.9633e-07 tau_t=6e-06 offset=-13.409 rt_offset=5
loss of tau to match HE        rec  28.6 (exp    25) :  14.5 % with (detector: V=120 mu_e=870 mu_t=58 tau_e=7.9633e-07 tau_t=6e-06 offset=-13.409 rt_offset=5
loss of tau to match HE        rec  61.7 (exp    59) :  4.61 % with (detector: V=120 mu_e=870 mu_t=58 tau_e=7.9633e-07 tau_t=6e-06 offset=-13.409 rt_offset=5
loss of tau to match HE        rec   505 (exp   511) : -1.13 % with (detector: V=120 mu_e=870 mu_t=58 tau_e=7.9633e-07 tau_t=6e-06 offset=-13.409 rt_offset=5
loss of tau to match LE        rec    27 (exp    25) :  7.89 % with (detector: V=120 mu_e=870 mu_t=58 tau_e=7.9633e-07 tau_t=6e-06 offset=-13.409 rt_offset=5
loss of tau to match LE        rec    58 (exp    59) :  -1.7 % with (detector: V=120 mu_e=870 mu_t=58 tau_e=7.9633e-07 tau_t=6e-06 offset=-13.409 rt_offset=5
loss of tau to match LE        rec   473 (exp   511) : -7.51 % with (detector: V=120 mu_e=870 mu_t=58 tau_e=7.9633e-07 tau_t=6e-06 offset=-13.409 rt_offset=5
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;RT (ISGRI Rise Time channel)&#39;)
</pre></div>
</div>
<img alt="_images/le-gain-offset_20_3.png" src="_images/le-gain-offset_20_3.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO:</span>
<span class="c1"># * reconstruct with det and morph</span>
</pre></div>
</div>
</div>
</div>
<p>It was suggested <a class="reference external" href="https://hal.archives-ouvertes.fr/hal-00000723/document">[1]</a> that for shallow interractions charge loss is negligible. This is certainly not the case as detector evolves. But it is also likely not the case already for the first in-flight measurements (and possibly for ground calibration).</p>
<p>RT for electrons is smaller than that for holes, but really shallow interractions.
The lowest RT is achieved for some characteristic depth, dependent on energy.</p>
<p>very shallow interactions have very small RT from holes,</p>
<p>But, in principle, <strong>low-RT counts always correspond to the same interaction depth, and experience the same field, same ballistic losses. They only differ in the amount of charge.</strong>. It means that they are affected by the same field.</p>
<p>#TODO find point as function of energy. find depth as function of RT range for different energies</p>
<p>There are not many ways to explain this. The best I can suggest for now is changes in detector homogenuity: polarization and/or charge carrier properties.</p>
<p>#TODO: combine and estimate field and detector properties inhomegenuity effect</p>
<p>#TODO: model field inhomogenuity to see what it does?</p>
<ul class="simple">
<li><p>In particular, it does not appear possible to achieve improvement in the high-RT collection in this way.
The tracks can never cross. An idea to achieve this was by stretiching the RT, which goes part of the way, but not enough.</p></li>
<li><p>The RT shift at low RT is incompatible with observations</p></li>
</ul>
<p>Inhomogenous field may be used to explain it.</p>
<p>Specifically, increase of field at higher depth and decrease at lower depth might produce the desired effects.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#TODO: deduce gain evolution just from the first line, assuming constant offset.</span>
<span class="c1">#TODO: reconstruction with mismatching detector configurations</span>
</pre></div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="landing-page.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Introduction to INTEGRAL IBIS/ISGRI modelling troubles</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="rapid-polarization.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Intra-revolution polarization</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By The Jupyter Book community<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>